
# アプリケーション設計の概要・理由

## モデル

* モデルは以下の三つ
  * Fp：フィナンシャルプランナーのアカウント情報（メールアドレス、パスワード）
  * User：ユーザーのアカウント情報（メールアドレス、パスワード）
  * Slot：予約枠の情報（開始日時、終了日時、担当FPへの参照、予約ユーザーへの参照）


* FPとユーザーは独立したモデル
  * 要求仕様に対しては同一の管理としてロールで分離する実装は容易だが本質的には異なる種類のアカウントであり、同じモデルとすべきではない
  * 最初の実装時に似通っていると共通化しても、その後の仕様変更によって個々に特有の管理情報や操作が出てきたときに共通化が実装のしやすさや見通しの良さの阻害になりかねない


* 予約枠はFP、ユーザーからの両方のhas_may（枠から見るとbelongs_to）の関連付け
  * FPもユーザーもそれぞれ予約枠を持つ（ユーザーは複数の枠を予約できる仕様としている）ため、それぞれのreferenceをつけた
  * FPが削除された場合は予約枠も消すべきなので、枠に対してdependent: :destroy
  * ユーザーが削除された場合は、予約を解放すべきなので、枠に対してdependent: :nullify
  * 時系列で操作することが多いと考えられるので、デフォルトスコープは枠の開始時間でソート


## ビュー

* サイト全体のナビゲーションのためにヘッダをつける

* 不特定多数の顧客であるユーザーの視点から、ユーザーを中心とした表示（アカウント登録、ログインのリンクの見つけやすさ）

* モデルの分離と同じ理由によって、それと直接紐づくFPとユーザーのアカウント管理系のページも分離


* 予約枠の登録・予約はモデルとは異なる理由で、同じtemplateを利用
  * 予約枠そのものはFP、ユーザーが共有（参照）するリソースであり、双方予定の表示・操作という意味でもレイアウトが似通っていて不自然ではない
  * 後で仕様変更が生じてFPとユーザーの間で全く異なる画面とする必要が生じても、モデルの構造ほどコアのアルゴリズムと密結合しない（させるべきではない）ため、比較的に分離・特化がしやすい


* 週カレンダーを用いて予約可能な枠と予約済みの枠を同時に見せる
  * FPに対しては、予約された枠が全体のどの程度の割合あるのか見渡せるように
  * ユーザーに対しては、自身が予約した枠以外にもどこがまだ空いているかわかるように


* カレンダーの横にログインアカウントの直近の予定を10件表示する
	* FPに対しては、自身が担当する時間帯を知ることができるように
	* ユーザーに対しては、自身の予定が（カレンダーからは遠い日でも）わかるように


* 予約の情報は参照当日付近から未来日に対してのみ表示


## コントローラー

* 予約関連のページは認可に基づいて表示
	* FPにはログイン前の時点で、個々のアカウントに依存しない予約情報を見せる意味はない
	* 予約の空き枠を表示することはユーザーにとって意味はあるが、今回はそこまで実装していない（本来は実装すべきだと考える；多くの予約・購入系のサイトではそのような実装になっていて、実際に予約・購入するときにログインページへ遷移する）


* 予約枠の登録・予約処理は未来日に対してのみ可能なようにバリデーション


* 予約枠の登録・予約処理はトランザクション管理対象
	* FPの登録については連続する時間帯を一度に予約可能なつくり（後述）としていて、一部の枠が営業時間外だった場合に同一の操作を取り消すため
	* ユーザーの予約については競合（他のユーザーの先取、FPのアカウント削除による枠の消失など）が発生しうるため


# 工夫点、アピールポイント

* 視認性・操作性の重視
	* カレンダービューを用いて一定の期間内の有効時間帯および予約枠の一覧性を確保する
	* カレンダービューに対して枠を直接クリックすることで直感的に枠の登録・予約ができるようにする
	* 不要な画面遷移は避け、予約に関するページは単一のものとする
	* 枠の登録時は30分単位で細かく登録要求するだけではなく、一定の区間を一度に（ドラッグして）登録できるようにし、サーバサイドの処理で30分単位に枠を分割する
	* 直近の予定がわかるようにカレンダービューの右横にリストを置く


* 枠の予約に対する仮定と見せ方
	* ユーザから見た専門家としてのFPには個性がないものと仮定した。すなわち、ユーザーからはFP個人を識別して予約する必要性がないものとした。
結果、FP故人の情報をカレンダービューに出す必要はなくなり、予約できる枠の有無さえわかればよい。予約の際に同時間帯に複数の枠が開いていた場合には、ランダムにひとつ選ぶこととした。
	* 枠の予約に対する仮定を覆したとしても現在のデザインは有効となるように考慮した。
FPの特性情報（経験、年齢、性別、得意分野など）をアカウント管理に追加し、ユーザーの検索によってFPに絞り込みをかけた結果から予約枠を選択する拡張を行うとしても、
カレンダービューは引き続き使うことができる。


* 個人的な経験の無さに対する実装上のチャレンジ
  * アカウント管理は要求仕様からはオーバースペックでも（そしてrails tutorialの一部を流用できても）、deviseをアカウント管理・認証に使った。利用頻度が高いライブラリも使って経験してみるべきと考えたため。
  * カレンダービューを使いたいところから要求仕様に対して適切なライブラリを探し、導入した。
  * ページ遷移を極力減らす方針を持って、カレンダービューの周辺でAjaxによる画面の部分更新を導入した。
  * 完全にRailsの外側だが今では常識のHTTPS対応。

# 懺悔

* システム全体を通して整合性のあるタイムゾーンの設定になっておらず、コーディングでその場しのぎのパッチを当てている
* 定数をリテラルでハードコードしまくっている
* Rubocopを最後にあててしまってoffense（convention）の数におののいたので、warning以上のみに絞って全て修正
